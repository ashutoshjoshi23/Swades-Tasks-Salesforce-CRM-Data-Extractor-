const S=e=>e.replace(/^\*/,"").replace(/:$/,"").replace(/\s+/g," ").trim(),w=e=>e.replace(/Edit\s+[A-Za-z\s]+$/,"").replace(/\n/g," ").trim(),A=()=>{var n;const e=window.location.href.toLowerCase();if(e.includes("/lead/"))return"leads";if(e.includes("/contact/"))return"contacts";if(e.includes("/account/"))return"accounts";if(e.includes("/opportunity/"))return"opportunities";if(e.includes("/task/"))return"tasks";const r=document.body.innerText;return r.includes("ObjectTask")||r.includes("Tasks (")||(((n=document.querySelector(".slds-page-header__title, .entityNameTitle, h1, .search-results-header"))==null?void 0:n.textContent)||"").includes("Task")?"tasks":null},T=()=>{var f;const e=A();if(!e)return[];const r=window.location.href,t=document.querySelectorAll('tr.slds-hint-parent, [role="row"], .slds-table tr, .search-result-item');if(t.length>0){const s=[];if(t.forEach((c,m)=>{var _;if(c.querySelector('th[scope="col"]')||c.classList.contains("slds-text-title_caps"))return;let a=c.querySelector('[data-label="Subject"] a, [data-label="Name"] a, a[data-recordid], a[href*="/lightning/r/"]');if(a||(a=c.querySelector("a.slds-truncate, th a, .slds-file__title a")),!a)return;const i=((_=a.textContent)==null?void 0:_.trim())||"Unknown";if(i==="Unknown"||i==="Select item"||i.length<2)return;let h=a.getAttribute("data-recordid");if(!h){const u=(a.href||"").match(/\/r\/[A-Za-z0-9]+\/([A-Za-z0-9]{15,18})/);h=u?u[1]:`row_${m}_${Date.now()}`}const p={id:h,name:i,objectType:e,extractedAt:new Date().toISOString(),url:a.href||r};c.querySelectorAll("td, th, .slds-list_horizontal > div").forEach(g=>{const u=S(g.getAttribute("data-label")||g.getAttribute("title")||"");if(u&&u.length>1&&!["Name","Action","Select"].some(x=>u.includes(x))){const x=g.cloneNode(!0);x.querySelectorAll("button, .slds-button, .slds-assistive-text, .slds-checkbox").forEach(v=>v.remove());const y=w(x.textContent||"");y&&y!==i&&(p[u.toLowerCase().replace(/[^a-z0-9]/g,"_")]=y)}}),s.push(p)}),s.length>0)return s}const n=r.match(/\/([a-zA-Z0-9]{15,18})\//),b=n?n[1]:`temp_${Date.now()}`,o=document.querySelector('lightning-formatted-name, .slds-page-header__title, [data-field="Name"], h1 slot, .entityNameTitle'),d=((f=o==null?void 0:o.textContent)==null?void 0:f.trim())||"Unknown",l={id:b,name:d,objectType:e,extractedAt:new Date().toISOString(),url:r};return document.querySelectorAll("lightning-output-field, .slds-form-element, .slds-page-header__detail-block").forEach(s=>{const c=s.querySelector(".test-id__field-label, .slds-form-element__label, .slds-text-title, .label"),m=s.querySelector(".test-id__field-value, .slds-form-element__control, .slds-text-body_regular, .value");if(c&&m){const a=S(c.textContent||""),i=m.cloneNode(!0);i.querySelectorAll("button, .slds-button, .slds-assistive-text").forEach(p=>p.remove());const h=w(i.textContent||"");a&&h&&(l[a.toLowerCase().replace(/[^a-z0-9]/g,"_")]=h)}}),l.name!=="Unknown"?[l]:[]};function k(e,r=!1){let t=document.getElementById("sf-extractor-notification-host");t&&t.remove(),t=document.createElement("div"),t.id="sf-extractor-notification-host",document.body.appendChild(t);const n=t.attachShadow({mode:"open"});n.innerHTML=`
        <style>
            .notification {
                position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px;
                background: ${r?"#FF4D4D":"#00A1E0"}; color: white;
                font-family: sans-serif; font-size: 14px; font-weight: 600;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 999999;
                animation: slideIn 0.3s ease-out;
            }
            @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        </style>
        <div class="notification">${e}</div>
    `,setTimeout(()=>t==null?void 0:t.remove(),4e3)}chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.action==="extract"){try{const n=T();n.length>0?chrome.storage.local.get("salesforce_data",b=>{const o=b.salesforce_data||{leads:[],contacts:[],accounts:[],opportunities:[],tasks:[],lastSync:0},d=n[0].objectType;n.forEach(l=>{const f=o[d].findIndex(s=>s.id===l.id||s.name===l.name);f>=0?o[d][f]={...o[d][f],...l}:o[d].push(l)}),o.lastSync=Date.now(),chrome.storage.local.set({salesforce_data:o},()=>{t({status:"success",count:n.length}),k(`Extracted ${n.length} ${d}!`)})}):(t({status:"error"}),k("No records found.",!0))}catch{t({status:"error"})}return!0}});
